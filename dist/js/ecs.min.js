/* ecs 17-01-2014 */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){"use strict";function c(a,b){this.name=a,this.definition=b,this._components=Object.create(null)}c.prototype.of=function(a,b){var c=this._components[a];if(2===arguments.length&&!this.in(a)){if(b.required)throw new Error;b.add&&(c=this.add(a))}return c},c.prototype.in=function(a){return a in this._components},c.prototype.add=function(a){if(this.in(a))throw new Error;var b=this.definition.apply(this,arguments);return this._components[a]=b,b},c.prototype.remove=function(a){return this.in(a)?(delete this._components[a],!0):!1},c.prototype.share=function(a,b){if(!this.in(a))return null;var c=this.of(a);if(Array.isArray(b))for(var d=b.length-1;d>=0;d-=1)this._components[b[d]]=c;else this._components[b]=c;return c},b.exports=c},{}],2:[function(a,b){"use strict";function c(a){if(a in c._definitions)return c._definitions[a];throw new Error}var d=a("./definition");c._definitions=Object.create(null),c.define=function(a,b){if(a in c._definitions)throw new Error;var e=new d(a,b);return c._definitions[a]=e,e},b.exports=c},{"./definition":1}],3:[function(a,b){"use strict";function c(a,b){this.name=a,this.definition=null,this._source=b,this._components=[],this._defaults=Object.create(null),this._sourceHasChanged=!0,this._componentsHaveChanged=!0,this._defaultsHaveChanged=!0,this._entities=[]}function d(a,b,c,d){if(c[a.name]=a._source[b],d.push(a.name),"extends"in a._source)for(var e=a._source.extends.slice();e.length>0;){var g=e.shift(),h=f(g)._source;g in c||("extends"in h&&e.unshift.apply(e,h.extends),c[g]=h[b],d.push(g))}}var e=a("../component"),f=a("../entity"),g=1;c.prototype.create=function(a){var b=g++;this._sourceHasChanged&&this.compile(),this.definition(b);for(var c in a)if(e(c).in(b)){var d=e(c).of(b),f=a[c];for(var h in f){for(var i=h.split("."),j=i.length-1,k=d,l=0;j>l;l+=1)k=k[i[l]];k[i[l]]=f[h]}}return this._entities.push(b),b},c.prototype.destroy=function(a){for(var b=this.components(),c=b.length-1;c>=0;c-=1)e(b[c]).remove(a);for(var d=this._entities.length-1;d>=0;d-=1)if(a===this._entities[d]){this._entities.splice(d,1);break}},c.prototype.source=function(a){return 0===arguments.length?this._source:("extends"in a&&(this._source.extends=a.extends,this._componentsHaveChanged=!0,this._defaultsHaveChanged=!0,this._sourceHasChanged=!0),"components"in a&&(this._source.components=a.components,this._componentsHaveChanged=!0,this._sourceHasChanged=!0),void("defaults"in a&&(this._source.defaults=a.defaults,this._defaultsHaveChanged=!0,this._sourceHasChanged=!0)))},c.prototype.components=function(){if(this._componentsHaveChanged){var a,b=Object.create(null),c=[];this._components.length=0,this._components.push.apply(this._components,this._source.components),d(this,"components",b,c),a=c.length;for(var e=0;a>e;e+=1){var f=b[c[e]];if(void 0!==f)a:for(var g=f.length-1;g>=0;g-=1){for(var h=f[g],i=this._components.length-1;i>=0;i-=1)if(h===this._components[i])continue a;this._components.push(h)}}this._componentsHaveChanged=!1}return this._components},c.prototype.defaults=function(){if(this._defaultsHaveChanged){var a=Object.create(null),b=[];d(this,"defaults",a,b);for(var c=b.length-1;c>=0;c-=1){var e=a[b[c]];if(void 0!==e)for(var f in e){var g,h=e[f];f in this._defaults||(this._defaults[f]=Object.create(null)),g=this._defaults[f];for(var i in h)g[i]=h[i]}}this._defaultsHaveChanged=!1}return this._defaults},c.prototype.compile=function(){var a="return function "+this.name+"Definition($id) {\n",b="}",c=this.components(),d=this.defaults(),f=Object.create(null),g=[];for(var h in d){var i="$"+g.length,j=d[h];g.push(i),f[h]=i;for(var k in j)b="  "+i+"."+k+" = "+JSON.stringify(j[k])+";\n"+b}a+="  var "+g.join(", ")+";\n",a+="\n";for(var l=c.length-1;l>=0;l-=1)a+="  ",c[l]in f&&(a+=f[c[l]]+" = "),a+='component("'+c[l]+'").add($id);\n';a+="\n",this.definition=new Function("component",a+b)(e),this._sourceHasChanged=!1},b.exports=c},{"../component":2,"../entity":4}],4:[function(a,b){"use strict";function c(a){if(a in c._definitions)return c._definitions[a];throw new Error}var d=a("./definition");c._definitions=Object.create(null),c.define=function(a,b){if(a in c._definitions)throw new Error;var e=new d(a,b);return c._definitions[a]=e,e},b.exports=c},{"./definition":3}],5:[function(a,b){"use strict";function c(a,b){if(a in c._definitions)return c._definitions[a](b);throw new Error}var d=/\s+/g,e=/[^&|!()]+|[&|!()]/g;c._definitions=Object.create(null),c._cache=Object.create(null),c._tokens=Object.create(null),c._tokens.and="&",c._tokens.or="|",c._tokens.not="!",c._tokens.open="(",c._tokens.close=")",c.tokens=function(a){if(0===arguments.length)return c._tokens;var b=c._tokens,d="";for(var f in b)f in a&&(b[f]=a[f]),d+=b[f];e=new RegExp("[^"+d+"]+|["+d+"]","g")},c.define=function(a,b){if(a in c._definitions)throw new Error;c._definitions[a]=b},c.compile=function(a){var b,f,g,h,i,j=a.replace(d,"");if(!(j in c._cache)){b=c._tokens,f="return function queryExpression($predicate) {\n  return !!(",g=");\n}",h=j.match(e);for(var k=0;i=h[k];k+=1)switch(i){case b.and:h[k]="&&";break;case b.or:h[k]="||";break;case b.not:h[k]="!";break;case b.open:h[k]="(";break;case b.close:h[k]=")";break;default:h[k]="$predicate("+JSON.stringify(i)+")"}try{h=new Function(f+h.join("")+g)()}catch(l){throw new Error}c._cache[j]=h}return c._cache[j]},b.exports=c},{}],6:[function(a,b){"use strict";function c(a,b,c,d){this.name=a,this.definition=b,this.components=c,this.context=d||this,this.entities=[],this.componentPacks=[]}var d=[];c.prototype.add=function(a,b){return this.componentPacks.push(b),this.entity.push(a),b},c.prototype.remove=function(a){var b=this.entities.indexOf(a);return 0>b?!1:(this.entities.splice(b,1),this.componentPack.splice(b,1),!0)},c.prototype.check=function(a){for(var b=this.components.length-1;b>0;b--)if(void 0===a[this.components[b]])return!1;return!0};var e=function(a,b){for(var c=d,e=this.components.length-1;e>0;e--)c.push(b[this.components[e]]);c.push(a),this.definition.apply(this.context,c),d.length=0};c.prototype.run=function(a,b){if(2===arguments.length)e.call(this,a,b);else for(var c=this.entities.length,d=0;c>d;d++)e.call(this,this.entities[d],this.componentPacks[d])},b.exports=c},{}],7:[function(a,b){"use strict";function c(a){if(a in c._definitions)return c._definitions[a];throw new Error}var d=a("./definition");c._definitions=Object.create(null),c._list=[],c._listLength=0,c.define=function(a,b,e,f){if(a in c._definitions)throw new Error;var g=new d(a,b,e,f);return c._definitions[a]=g,c._list.push(a),c._listLength++,g},c.order=function(a){return Array.isArray(a)&&(c._list=a),c._listLength=c._list.length,c._list},c.run=function(){for(var a=0;a<c._listLength;a++)c._list[a].run()},c.refresh=function(a){for(var b=0;b<c._listLength;b++){var d=a.components();c._list[b].check(d)?c._list[b].add(a,d):c._list[b].remove(a)}},b.exports=c},{"./definition":6}],8:[function(a){"use strict";window.component=a("./core/component"),window.system=a("./core/system"),window.entity=a("./core/entity"),window.Pool=a("./pool").Pool,window.FixedPool=a("./pool").FixedPool},{"./core/component":2,"./core/entity":4,"./core/system":7,"./pool":11}],9:[function(a,b){"use strict";function c(a,b){this._pool=[],this._defered=[],this._size=2===arguments.length?"size"in b?b.size:c.defaults.size:c.defaults.size;for(var d=0;d<this._size;d+=1)this._pool.push(a())}c.prototype.create=function(){if(this._size>0){var a=this._pool[--this._size];return this._pool[this._size]=null,a}},c.prototype.defer=function(a){if(this._size>0){var b=this._pool[--this._size];this._pool[this._size]=null,a(b)}else this._defered.push(a)},c.prototype.release=function(a){this._defered.length>0?this._defered.shift()(a):this._pool[this._size++]=a},c.prototype.size=function(){return this._pool.length},c.prototype.freeSize=function(){return this._size},c.prototype.allocatedSize=function(){return this._pool.length-this._size},c.defaults={size:100},b.exports=c},{}],10:[function(a,b){"use strict";function c(a,b){this._factory=a,this._pool=[],this._defered=[],2===arguments.length?(this._size="size"in b?b.size:c.defaults.size,this.growth="growth"in b?b.growth:c.defaults.growth,this.threshold="threshold"in b?b.threshold:c.defaults.threshold):(b=c.defaults,this._size=b.size,this.growth=b.growth,this.threshold=b.threshold),this.allocate(this._size)}c.prototype.create=function(){return this._pool.length<this.threshold&&this.allocate(this.growth),this._pool.pop()},c.prototype.defer=function(a){this._pool.length>0?a(this._pool.pop()):this._defered.push(a)},c.prototype.allocate=function(a){for(var b=0;a>b;b+=1)this._pool.push(this._factory())},c.prototype.release=function(a){this._defered.length>0?this._defered.shift()(a):this._pool.push(a)},c.prototype.size=function(){return this._size},c.prototype.freeSize=function(){return this._pool.length},c.prototype.allocatedSize=function(){return this._size-this._pool.length},c.defaults={size:100,growth:1,threshold:1},b.exports=c},{}],11:[function(a,b,c){"use strict";var d=a("./Pool"),e=a("./FixedPool");c.Pool=d,c.FixedPool=e},{"./FixedPool":9,"./Pool":10}]},{},[1,2,3,4,5,6,7,8,9,10,11]);